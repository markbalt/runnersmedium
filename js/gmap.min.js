var map=null;var geocoder=null;var route=new Array(0);var distance=0;var units;var firstmarker=null;var miles={get:function(b){return b/1609.344}};var km={get:function(b){return b/1000}};function showit(d){if(d&&d.Status.code==200){place=d.Placemark[0];var c=place.AddressDetails.Country.AdministrativeArea.Locality.LocalityName+", "+place.AddressDetails.Country.AdministrativeArea.AdministrativeAreaName+" "+place.AddressDetails.Country.CountryName;if(c.length>32){c.substr(32)}$("city").value=c}}function initialize(){if(GBrowserIsCompatible()){if($("units").innerHTML=="km"){units=km}else{units=miles}map=new GMap2(document.getElementById("gmap"));geocoder=new GClientGeocoder();map.addControl(new GLargeMapControl());map.addControl(new GMapTypeControl());if($F("params")!=""){openRoute($F("params"))}else{if($F("location")!=""){showAddress($F("location"))}else{map.setCenter(new GLatLng(38,-97),3)}}GEvent.addListener(map,"click",function(c,d){if(d){map.clearOverlays();route.push(d);map.addOverlay(new GPolyline(route));if(route.length==1){createFirstMarker()}map.addOverlay(firstmarker);if(route.length>1){map.addOverlay(new GMarker(route[route.length-1],{clickable:false,draggable:false,bouncy:false}));distance+=getDistance(route[route.length-2],route[route.length-1]);updateForm()}}})}else{$("gmap").innerHTML="Sorry, the Google Maps API is not compatible with this browser"}}function createFirstMarker(){firstmarker=new GMarker(route[0],{clickable:true,draggable:false,bouncy:false});GEvent.addListener(firstmarker,"click",function(){if(route.length>2){map.clearOverlays();route.push(route[0]);map.addOverlay(new GPolyline(route));distance+=getDistance(route[route.length-2],route[route.length-1]);updateForm();map.addOverlay(firstmarker)}})}function showAddress(b){if(geocoder){geocoder.getLatLng(b,function(a){if(!a){}else{map.setCenter(a,15);geocoder.getLocations(a,showit)}})}}Math.deg2rad=function(b){return b*(Math.PI/180)};function calcDistance(d){if(d.length<2){return 0}var f=0;for(var e=0;e<d.length-1;e++){f+=getDistance(d[e],d[e+1])}return f}function getDistance(b,c){var l=6367000;var m=Math.deg2rad(90-b.y);var n=Math.deg2rad(90-c.y);var k=Math.deg2rad(c.x-b.x);var a=Math.acos(Math.cos(m)*Math.cos(n)+Math.sin(m)*Math.sin(n)*Math.cos(k));return a*l}function stepBack(){if(route.length<2){return}route.pop();map.clearOverlays();map.addOverlay(new GPolyline(route));map.addOverlay(new GMarker(route[0]));map.addOverlay(new GMarker(route[route.length-1]));distance=calcDistance(route);updateForm()}function startOver(){route=[];map.clearOverlays();distance=0;updateForm()}function updateForm(){dist=units.get(distance).toFixed(2);$("distance").value=dist;$("status").innerHTML=dist+" "+$("units").innerHTML}function saveRoute(){var g=[];var h=map.getZoom();g.push("zoom="+h);var f=map.getCenter();f=encodePoints(new Array(f));g.push("center="+f);var e=encodePoints(route);g.push("path="+e);$("params").value=g.join("&");return true}function openRoute(n){var j=new Object();var h=n.split("&");var l=/(\w+)=(.+)/;for(var m=0;m<h.length;m++){if((result=l.exec(h[m]))!=null){var k=result[1];j[k]=result[2]}}var i=decodePoints(j.center);map.setCenter(new GLatLng(i[0].y,i[0].x),parseInt(j.zoom));if(j.path){route=decodePoints(j.path);map.addOverlay(new GPolyline(route));createFirstMarker();map.addOverlay(firstmarker);map.addOverlay(new GMarker(route[route.length-1]));distance=calcDistance(route)}updateForm()}function encodePoints(i){var o=0;var n=0;var p="";for(var q=0;q<i.length;q++){var m=i[q].x;var l=i[q].y;var r=Math.floor(m*100000);var k=Math.floor(l*100000);dlat=r-o;dlng=k-n;o=r;n=k;p+=encodeSignedNumber(dlat)+encodeSignedNumber(dlng)}return p}function encodeSignedNumber(d){var c=d<<1;if(d<0){c=~(c)}return(encodeNumber(c))}function encodeNumber(c){var d="";while(c>=32){d+=(String.fromCharCode((32|(c&31))+63));c>>=5}d+=(String.fromCharCode(c+63));return d}function decodePoints(u){if(u.length==0){return}var s=u.length;var t=0;var q=[];var o=0;var n=0;while(t<s){var m;var v=0;var b=0;do{m=u.charCodeAt(t++)-63;b|=(m&31)<<v;v+=5}while(m>=32);var r=((b&1)?~(b>>1):(b>>1));o+=r;v=0;b=0;do{m=u.charCodeAt(t++)-63;b|=(m&31)<<v;v+=5}while(m>=32);var p=((b&1)?~(b>>1):(b>>1));n+=p;q.push(new GLatLng(n*0.00001,o*0.00001))}return q};